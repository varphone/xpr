include ../Common.mk
-include ../Config.mk

CFLAGS          = $(BUILD_OPT_FLAGS) -D_BSD_SOURCE -D_GNU_SOURCE -DPIC -fPIC -I../include
CXXFLAGS        =
LDFLAGS         = -L../lib
libxpr_DEFS     =
libxpr_OBJS     =
libxpr_CFLAGS   =
libxpr_CXXFLAGS =
libxpr_LDFLAGS  = -shared -Wl,--version-script=libxpr.sym
libxpr_LIBS     =

include Modules.mk

config_FILE = ../include/xpr/xpr_config.h
config_VARS = $(sort $(foreach v,$(sort $(.VARIABLES)),$(filter XPR_%,$v)))

CFLAGS      += -DHAVE_STDINT_H=1 -DHAVE_MP=1 $(libxpr_DEFS)
CFLAGS      += -include $(config_FILE) $(libxpr_CFLAGS)
ifneq ($(TOOLSET_NAME),)
CFLAGS      += -I../contrib/$(TOOLSET_NAME)/include
LDFLAGS     += -L../contrib/$(TOOLSET_NAME)/lib
endif
CXXFLAGS    += $(CFLAGS) $(libxpr_CXXFLAGS)
libxpr_LIBS += -Wl,-Bdynamic -lstdc++ -lpthread -lm -ldl

targets =
ifeq ($(BUILD_STATIC),y)
targets += libxpr.a
endif
ifeq ($(BUILD_SHARED),y)
targets += libxpr.so
endif

all: prepare $(targets) local_install

prepare: $(config_FILE) $(config_VARS) config_DEFS

libxpr.a: $(libxpr_OBJS)
	$(ECHO) "[  Archive] $@"
	$(AR) crv $@ $^

libxpr.so: $(libxpr_OBJS)
	$(ECHO) "[     Link] $@"
	$(LD) $(LDFLAGS) $(libxpr_LDFLAGS) $^ -o $@ $(libxpr_LIBS)

%.o: %.cpp
	$(ECHO) "[Compiling] $^"
	$(CXX) $(CXXFLAGS) $($(call filter_spc,$^)_CXXFLAGS) -c $^ -o $@

%.o: %.c
	$(ECHO) "[Compiling] $^"
	$(CC) $(CFLAGS) $($(call filter_spc,$^)_CFLAGS) -c $^ -o $@

$(config_FILE):
	@echo "// Auto generated by Makefile" > $@
	@echo "// Date: $$(date)\n" >> $@

$(config_VARS): $(config_FILE)
	@echo "// $(@)" >> $^; \
	if [ x$($(@)) = xy ]; then \
	  echo "#define HAVE_$@ 1" >> $^; \
	else \
	  echo "#undef HAVE_$@" >> $^; \
	fi; \
	echo "" >> $^; \

config_DEFS: $(config_FILE)
	@echo "#define HAVE_SIGNAL_H 1" >> $^
	@echo "#define HAVE_PTHREAD_H 1" >> $^
	@echo "#define HAVE_TIME_H 1" >> $^
	@echo "#define HAVE_UNISTD_H 1" >> $^

clean:
	$(RM) $(libxpr_OBJS) $(targets)

local_install: $(targets)
	$(ECHO) "[  Install] Copy $^ to ../lib/"
	@[ -d ../lib/ ] || mkdir ../lib
	$(CP) $^ ../lib/

strip: libxpr.so
	$(STRIP) $^
	make local_install

.PHONY: $(config_FILE)

